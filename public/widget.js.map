{"version":3,"file":"widget.js","sources":["../src/widget.js"],"sourcesContent":["const WIDGET_URL = process.env.WIDGET_URL;\n\nfunction widget(options = {}) {\n    if (!validate(options)) return;\n\n    let { target } = options;\n\n    if (typeof target === 'string') {\n        target = document.querySelector(target);\n    }\n\n    if (!target) {\n        console.error('Speechki Widget error: No such target element found');\n    }\n\n    const iframe = document.createElement('iframe');\n    const src = process.env.WIDGET_URL + '/?' + createQuery(options);\n    iframe.setAttribute('src', src);\n    iframe.style.background = 'transparent';\n    iframe.style.visibility = 'visible';\n    iframe.style.border = '0';\n    iframe.style.width = '100%';\n    iframe.style.height = '100%';\n\n    target.appendChild(iframe);\n\n    const widget = new Widget(iframe);\n\n    return widget;\n}\n\nfunction validate(options = {}) {\n    const requireds = ['target', 'book_language', 'customer_id'];\n\n    const errors = [];\n    const entries = Object.entries(options);\n\n    entries.forEach(([key, value]) => {\n        if (Boolean(requireds.includes(key) && value)) return;\n\n        errors.push(`Speechki Widget error: Please specify ${key}`);\n    });\n\n    if (!errors.length) return true;\n    errors.forEach((e) => console.error(e));\n}\n\nfunction createQuery(options) {\n    const forward = ['customer_id', 'book_language'];\n\n    const params = new URLSearchParams();\n    forward.forEach((p) => params.set(p, options[p]));\n\n    return params.toString();\n}\n\nclass Widget {\n    constructor(instance) {\n        this.instance = instance;\n        this.subs = {};\n\n        window.addEventListener('message', this.select);\n        window.addEventListener('beforeunload', () => {\n            window.removeEventListener('message');\n        });\n    }\n\n    select({ data }) {\n        if (data.event === 'speechki-select') {\n            this.fire('select', this.data(data));\n        }\n    }\n\n    data(data) {\n        data.event = data.event.replace('speechki-', '');\n        return data;\n    }\n\n    on(event, handler) {\n        let handlers = this.subs[event];\n\n        if (!handlers) {\n            handlers = this.subs[event] = [];\n        }\n\n        handlers.push(handler);\n\n        return {\n            name: event,\n            callback: handler,\n            off: (event, handler) => this.off(event, handler),\n        };\n    }\n\n    off(event, handler) {\n        if (!this.handlers[event]) return;\n\n        let handlers = this.subs[event];\n\n        if (handler) {\n            subs = subs.filter((h) => h != fn);\n            return;\n        }\n\n        handlers.length = 0;\n    }\n\n    offAll() {\n        for (let prop in this.subs) {\n            if (this.subs.hasOwnProperty(prop)) {\n                this.off(prop);\n            }\n        }\n    }\n\n    fire(event, ...args) {\n        let handlers = this.subs[event];\n\n        if (!handlers || !handlers.length) return;\n\n        handlers.forEach((h) => {\n            h(...args);\n        });\n    }\n\n    changeLanguage(language) {\n        if (!language) {\n            console.error('Speechki Widget: Please specify language');\n            return;\n        }\n\n        this.instance.contentWindow.postMessage({\n            event: 'change_language',\n            data: {\n                language,\n            },\n        });\n    }\n}\n\nexport default {\n    widget,\n};\n"],"names":[],"mappings":"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"}